name: Convert Markdown to PDF on Tag

on:
    push:
        tags:
            - "*"
    workflow_dispatch: {}
jobs:
    convert-to-pdf:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Verify tag is on main branch
              run: |
                  # Fetch all branches and tags
                  git fetch --all --tags
                  # Get the commit SHA that the tag points to
                  TAG_SHA=$(git rev-parse ${{ github.ref_name }})
                  # Check if this commit is in main branch
                  if git branch -r --contains $TAG_SHA | grep -q 'origin/main'; then
                    echo "Tag ${{ github.ref_name }} is on main branch"
                  else
                    echo "Tag ${{ github.ref_name }} is not on main branch, skipping"
                    exit 1
                  fi

            - name: Install dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y \
                    pandoc \
                    texlive-xetex \
                    texlive-lang-chinese \
                    texlive-fonts-recommended \
                    fonts-noto-cjk \
                    fonts-noto-cjk-extra

            - name: Convert Markdown files to PDF
              run: |
                  mkdir -p product

                  # Convert 300字短答_為何申請.md
                  pandoc "2025_明緯獎學金_李沛宸/01_申請書/300字短答_為何申請.md" \
                    -o "product/300字短答_為何申請.pdf" \
                    --pdf-engine=xelatex \
                    -V CJKmainfont="Noto Sans CJK TC" \
                    -V geometry:margin=2cm \
                    --template=default

                  # Convert 自傳.md
                  pandoc "2025_明緯獎學金_李沛宸/02_自傳與學習計畫/自傳.md" \
                    -o "product/自傳.pdf" \
                    --pdf-engine=xelatex \
                    -V CJKmainfont="Noto Sans CJK TC" \
                    -V geometry:margin=2cm \
                    --template=default

                  # Convert 短期學習計畫.md
                  pandoc "2025_明緯獎學金_李沛宸/02_自傳與學習計畫/短期學習計畫.md" \
                    -o "product/短期學習計畫.pdf" \
                    --pdf-engine=xelatex \
                    -V CJKmainfont="Noto Sans CJK TC" \
                    -V geometry:margin=2cm \
                    --template=default

                  # Convert 未來工作應用.md
                  pandoc "2025_明緯獎學金_李沛宸/02_自傳與學習計畫/未來工作應用.md" \
                    -o "product/未來工作應用.pdf" \
                    --pdf-engine=xelatex \
                    -V CJKmainfont="Noto Sans CJK TC" \
                    -V geometry:margin=2cm \
                    --template=default

            - name: Commit and push PDF files
              env:
                  GITHUB_REF: ${{ github.ref }}
                  GITHUB_REF_NAME: ${{ github.ref_name }}
                  GITHUB_HEAD_REF: ${{ github.head_ref }}
              run: |
                  mkdir -p .cursor
                  LOG_FILE=".cursor/debug.log"

                  # #region agent log
                  echo "{\"id\":\"log_$(date +%s)_A\",\"timestamp\":$(date +%s)000,\"location\":\"convert-to-pdf.yml:83\",\"message\":\"Git state before config\",\"data\":{\"ref\":\"$GITHUB_REF\",\"ref_name\":\"$GITHUB_REF_NAME\",\"head_ref\":\"$GITHUB_HEAD_REF\",\"current_branch\":\"$(git branch --show-current 2>/dev/null || echo 'detached')\",\"head_state\":\"$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'detached')\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"A\"}" | tee -a "$LOG_FILE"
                  # #endregion

                  git config --local user.email "action@github.com"
                  git config --local user.name "GitHub Action"

                  # #region agent log
                  echo "{\"id\":\"log_$(date +%s)_B\",\"timestamp\":$(date +%s)000,\"location\":\"convert-to-pdf.yml:90\",\"message\":\"Git state after config, before checkout\",\"data\":{\"current_branch\":\"$(git branch --show-current 2>/dev/null || echo 'detached')\",\"head_state\":\"$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'detached')\",\"is_detached\":\"$(git rev-parse --abbrev-ref HEAD 2>/dev/null | grep -q '^HEAD$' && echo 'true' || echo 'false')\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"A,C\"}" | tee -a "$LOG_FILE"
                  # #endregion

                  # Checkout to main branch before committing
                  git checkout main || git checkout -b main origin/main

                  # #region agent log
                  echo "{\"id\":\"log_$(date +%s)_C\",\"timestamp\":$(date +%s)000,\"location\":\"convert-to-pdf.yml:95\",\"message\":\"Git state after checkout main\",\"data\":{\"current_branch\":\"$(git branch --show-current 2>/dev/null || echo 'detached')\",\"head_state\":\"$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo 'detached')\",\"remote_tracking\":\"$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || echo 'none')\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"C\"}" | tee -a "$LOG_FILE"
                  # #endregion

                  if [ -n "$(git status --porcelain product/)" ]; then
                    # #region agent log
                    echo "{\"id\":\"log_$(date +%s)_D\",\"timestamp\":$(date +%s)000,\"location\":\"convert-to-pdf.yml:100\",\"message\":\"Changes detected, before add\",\"data\":{\"changes\":\"$(git status --porcelain product/ | head -5)\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"A\"}" | tee -a "$LOG_FILE"
                    # #endregion
                    
                    git add product/
                    git commit -m "chore: Generate PDF files from Markdown on tag $GITHUB_REF_NAME"
                    
                    # #region agent log
                    echo "{\"id\":\"log_$(date +%s)_E\",\"timestamp\":$(date +%s)000,\"location\":\"convert-to-pdf.yml:106\",\"message\":\"After commit, before push\",\"data\":{\"current_branch\":\"$(git branch --show-current 2>/dev/null || echo 'detached')\",\"commit_sha\":\"$(git rev-parse HEAD)\",\"ahead_count\":\"$(git rev-list --count HEAD ^origin/main 2>/dev/null || echo 'unknown')\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"B\"}" | tee -a "$LOG_FILE"
                    # #endregion
                    
                    git push origin main
                    PUSH_EXIT_CODE=$?
                    
                    # #region agent log
                    echo "{\"id\":\"log_$(date +%s)_F\",\"timestamp\":$(date +%s)000,\"location\":\"convert-to-pdf.yml:111\",\"message\":\"After push attempt\",\"data\":{\"push_exit_code\":\"$PUSH_EXIT_CODE\",\"current_branch\":\"$(git branch --show-current 2>/dev/null || echo 'detached')\"},\"sessionId\":\"debug-session\",\"runId\":\"run1\",\"hypothesisId\":\"B\"}" | tee -a "$LOG_FILE"
                    # #endregion
                    
                    if [ $PUSH_EXIT_CODE -ne 0 ]; then
                      exit $PUSH_EXIT_CODE
                    fi
                  else
                    echo "No changes to commit"
                  fi

            - name: Upload debug logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: debug-logs
                  path: .cursor/debug.log
                  if-no-files-found: ignore
